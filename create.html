<!DOCTYPE html>
<html>
<head>
	<title>Создать карточку объекта</title>
	<meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link href="css/ratchet.css" rel="stylesheet">
    <script src="js/ratchet.js"></script>		
</head>
<body>
	<header class="bar bar-nav">
		<a href="index.html">
			<button class="btn btn-link btn-nav pull-left">
	    	<span class="icon icon-left-nav"></span>
	    		Назад
	  		</button>
	  	</a>
      <h1 class="title">Создать карточку</h1>
    </header>

    <div class="content">
    	<p class="content-padded">При загрузке этой страницы система может запросить разрешение на использование видеокамеры.</p>
    	<div class="content-padded">
	   		<p>1. Введите название объекта</p>
	   		<input id="description" type="text">
  		</div>
    	<div class="content-padded" id="step2">
	   		<p>2. Наведите камеру на объект и сфотографируйте его</p>
   		   	<div><video id="video" style="width:100%" autoplay></video></div>
		   	<div><button class="btn btn-primary btn-block" id="snap">Сфотографировать</button></div>
  		</div>
    	<div class="content-padded" id="step3" style="display:none">
		   	<div><canvas id="canvas"></canvas></div>
			<p>3. Создайте навиадрес объекта</p>
		   	<button class="btn btn-primary btn-block" id="create">Создать навиадрес</button>
  		</div>

    </div>

   	<p id="info"></p>
   	<p id="label"></p>

<script>
var video = document.getElementById('video');
var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');
console.log(video);

// Создаем видеопоток
if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
        video.src = window.URL.createObjectURL(stream);
        video.play();
    });
}	

// Добавляем событие по нажатию
document.getElementById("snap").addEventListener("click", function() {
	let w = video.clientWidth;
	let h = video.clientHeight;

	document.getElementById("step2").style.display = "none";
	document.getElementById("step3").style.display = "block";
	context.drawImage(video, 0, 0, w, h);
});

document.getElementById("create").addEventListener("click", function() {
	// Получаем токен для авторизации
	getToken().then((token)=>{
		createNaviaddress(token);
	});
});


// Получить токен
function getToken() {
	return new Promise((resolve,reject) => {
		let url = 'https://staging-api.naviaddress.com/api/v1.5/Sessions';
		let params = {
			password:'qwerty',    // Пароль и логин для доступа к API 
			Email:'test@test.com'  //  нужно получить заполнив форму регистрации
		};

		fetch(url,
		{
		    headers: {
		      'Accept': 'application/json',
		      'Content-Type': 'application/json'
		    },
		    method: "POST",
		    body: JSON.stringify(params)
		})
		.then((res1) => {
			res1.json().then((res2) => resolve(res2.token))
		});
	});
}

function createNaviaddress(token) {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
        	(position)=>{
        		let coords = position.coords;

				let url = 'https://api.naviaddress.com/api/v1.5/addresses/';
        		let body = {
        			lat: coords.latitude,
        			lng: coords.longitude,
        			description: "Инвентаризатор: "+document.getElementById("description").value,
        			address_type: "free", 
        			default_lang: "ru"
        		};

				fetch(url,
				{
				    headers: {
				      'Accept': 'application/json',
				      'Content-Type': 'application/json',
				      'auth-token': token
				    },
				    method: "POST",
				    body: JSON.stringify(body)
				}).then((res1) => {
					console.log(res1);
					alert('Объект создан');
					reject();
					/*
					res1.json().then((res2) => {
						console.log(97,res2);
					});
					*/
				});
		});

    } else {
    	alert("Геолокация не поддерживается вашим браузером");
    }
}

</script>


</body>
</html>